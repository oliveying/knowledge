
# ä»€ä¹ˆæ˜¯alinode
Node.js æ€§èƒ½å¹³å° ( Node.js Performance Platformï¼ŒåŸ alinode ) æ˜¯é¢å‘æ‰€æœ‰ Node.js åº”ç”¨æä¾› æ€§èƒ½ç›‘æ§ã€å®‰å…¨æé†’ã€æ•…éšœæ’æŸ¥ã€æ€§èƒ½ä¼˜åŒ– ç­‰æœåŠ¡çš„æ•´ä½“æ€§è§£å†³æ–¹æ¡ˆï¼Œå°¤å…¶é€‚ç”¨äºä¸­å¤§å‹ Node.js åº”ç”¨ã€‚

egg-alinodeä¸ºeggç”¨äºæ”¯æŒalinodeçš„æ’ä»¶

## Node æ€§èƒ½ä¼˜åŒ–ä¸é—®é¢˜æ’æŸ¥
* æœåŠ¡æ€§èƒ½æŒ‡æ ‡

### ååé‡

* QPS (TPS)ï¼šæ¯ç§’æŸ¥è¯¢ç‡QPSæ˜¯å¯¹ä¸€ä¸ªç‰¹å®šçš„æŸ¥è¯¢æœåŠ¡å™¨åœ¨è§„å®šæ—¶é—´å†…æ‰€å¤„ç†æµé‡å¤šå°‘çš„è¡¡é‡æ ‡å‡†ï¼Œé€šå¸¸ç”¨æ¥è¡¨è¾¾å’Œè¡¡é‡å½“å‰ç³»ç»Ÿçš„è´Ÿè½½

* å¹¶å‘æ•°ï¼šç³»ç»ŸåŒæ—¶å¤„ç†çš„request/äº‹åŠ¡æ•°

* å“åº”æ—¶é—´ï¼šä¸€èˆ¬å–å¹³å‡å“åº”æ—¶é—´

* å…³ç³»ï¼š QPS = å¹¶å‘é‡ / å¹³å‡å“åº”æ—¶é—´
  ä¸€ä¸ªç³»ç»Ÿååé‡é€šå¸¸ç”±QPSï¼ˆTPSï¼‰ã€å¹¶å‘æ•°ä¸¤ä¸ªå› ç´ å†³å®šï¼Œæ¯å¥—ç³»ç»Ÿè¿™ä¸¤ä¸ªå€¼éƒ½æœ‰ä¸€ä¸ªç›¸å¯¹æé™å€¼ï¼Œåœ¨åº”ç”¨åœºæ™¯è®¿é—®å‹åŠ›ä¸‹ï¼Œåªè¦æŸä¸€é¡¹è¾¾ åˆ°ç³»ç»Ÿæœ€é«˜å€¼ï¼Œç³»ç»Ÿçš„ååé‡å°±ä¸Šä¸å»äº†ï¼Œå¦‚æœå‹åŠ›ç»§ç»­å¢å¤§ï¼Œç³»ç»Ÿçš„ååé‡åè€Œä¼šä¸‹é™ï¼ŒåŸå› æ˜¯ç³»ç»Ÿè¶…è´Ÿè·å·¥ä½œï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€å†…å­˜ç­‰ç­‰å…¶å®ƒæ¶ˆè€—å¯¼è‡´ç³»ç»Ÿæ€§èƒ½ä¸‹ é™!

å¦‚æœæƒ³è¦æé«˜ç³»ç»Ÿååé‡ï¼Œå°±éœ€è¦å…ˆè¿›è¡Œæ€§èƒ½æµ‹è¯•ï¼Œæµ‹å‡ºç³»ç»Ÿæé™ï¼Œç„¶åå†è¿›è¡Œæ€§èƒ½è°ƒä¼˜ã€‚

* ä½¿ç”¨ [JMeter](https://jmeter.apache.org/download_jmeter.cgi) è¿›è¡Œæ€§èƒ½æµ‹è¯• 

ä¸‹è½½jmeterï¼Œç„¶åè§£å‹åˆ°ä»»æ„ç›®å½•ï¼Œæ‰§è¡Œbinæ–‡ä»¶å¤¹ä¸‹çš„ jmeter.shåœ¨å‡ºç°çš„UIç•Œé¢ä¸Šè¿›è¡Œå¯¹ä½ çš„node æœåŠ¡è¿›è¡Œç›¸åº”æµ‹è¯•ï¼Œå…·ä½“å¦‚ä½•æµ‹è¯•å¯ä»¥Googleã€‚å¯ä»¥æµ‹å‡ºç¨‹åºçš„ååé‡ã€‚

### å†…å­˜æ³„éœ²
å†…å­˜æ³„æ¼ï¼ˆMemory Leakï¼‰æŒ‡ç”±äºç–å¿½æˆ–é”™è¯¯é€ æˆç¨‹åºæœªèƒ½é‡Šæ”¾å·²ç»ä¸å†ä½¿ç”¨çš„å†…å­˜çš„æƒ…å†µã€‚

å¦‚æœä¸€ä¸ªç¨‹åºå­˜åœ¨å†…å­˜æ³„éœ²ï¼Œåˆ™éšç€æ—¶é—´çš„æ¨ç§»ï¼Œå†…å­˜å ç”¨è¶Šæ¥è¶Šæ¥ï¼Œç¨‹åºä¹Ÿå°±ä¼šè¶Šæ¥è¶Šå¡ï¼Œå¯¼è‡´ç³»ç»Ÿæ€§èƒ½ä¸‹é™ï¼Œååé‡ä¸‹é™ï¼Œå› æ­¤å¦‚æœå‘ç°ä½ çš„ç¨‹åºè¶Šæ¥è¶Šæ…¢ï¼Œé‚£å¯èƒ½å­˜åœ¨å†…å­˜æ³„éœ²é—®é¢˜ã€‚

### æ€§èƒ½ä¼˜åŒ–
heapdumpæˆ–ä½¿ç”¨ v8-profiler

è¿™ä¸¤ä¸ªå·¥å…·çš„åŸç†éƒ½æ˜¯ä¸€è‡´çš„ï¼šè°ƒç”¨v8å¼•æ“æš´éœ²çš„æ¥å£ï¼š

`v8::Isolate::GetCurrent()->GetHeapProfiler()->TakeHeapSnapshot(title, control)`

ç„¶åå°†è·å–çš„c++å¯¹è±¡æ•°æ®è½¬æ¢ä¸ºjså¯¹è±¡ã€‚

è¿™é‡Œæ¨èä½¿ç”¨v8-profilerå› ä¸ºå¤šä¸€ä¸ªcpuå¿«ç…§åŠŸèƒ½

[node-inspector/v8-profiler](https://github.com/node-inspector/v8-profiler)

* å¿«ç…§
æˆ‘ä»¬ä¸ºç¨‹åºæ·»åŠ ä¸€ä¸ªè¿›è¡Œå¿«ç…§çš„è·¯ç”±ï¼Œåœ¨æœåŠ¡ä¸€å¼€å§‹è¿è¡Œçš„æ—¶å€™å¼€å§‹CPUåˆ†æå¹¶è¿›è¡Œç¬¬ä¸€æ¬¡å †å¿«ç…§ï¼Œæ–¹ä¾¿åé¢å¯¹æ¯”ï¼ŒæœåŠ¡ç«¯æ¥å—åˆ°è¿™ä¸ªGetè¯·æ±‚æ—¶ï¼Œè¿›è¡Œåœæ­¢åˆ†æï¼Œå¹¶è¿›è¡Œå †å¿«ç…§å’ŒCPUå¿«ç…§ï¼Œä¿å­˜å¿«ç…§æ–‡ä»¶ã€‚
```js
const fs = require('fs');
const profiler = require('v8-profiler');

profiler.startProfiling();
const snapshot1 = profiler.takeSnapshot();

router.get('/profiler', async (ctx) => {
  const perf = profiler.stopProfiling();
  perf
    .export()
    .pipe(fs.createWriteStream('profiler.cpuprofile'))
    .on('finish', () => perf.delete());

  const snapshot2 = profiler.takeSnapshot();

  snapshot1.export((error, result) => {
    if (error) console.log(error);
    fs.writeFileSync('snapshot1.heapsnapshot', result);
    snapshot1.delete();
  });

  snapshot2
    .export()
    .pipe(fs.createWriteStream('snapshot2.heapsnapshot'))
    .on('finish', snapshot2.delete);
  ctx.body = {
    msg: 'success take profile',
  };
});

```
okï¼Œç„¶åä½¿ç”¨Jmeterè¿›è¡Œå¹¶å‘æµ‹è¯•ï¼Œåœ¨åˆé€‚çš„æ—¶æœºè¯·æ±‚æœåŠ¡profileræ¥å£ï¼Œå¾—åˆ°3ä¸ªæ–‡ä»¶.

snapshot1.heapsnapshot

snapshot2.heapsnapshot

profiler.cpuprofile

* åˆ†æ
åˆ†ææ–¹å¼å¯ä»¥ä½¿ç”¨chrome devtoolsè¿›è¡Œåˆ†æï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨alinodeè¿›è¡Œåˆ†æ

ä½¿ç”¨chrome devtool è¿›è¡Œåˆ†æ
image

ç‚¹å¼€Memoryé¢æ¿ï¼Œå·¦ä¾§è¾¹æ å³é”®loadï¼Œé€‰æ‹©åˆšæ‰çš„2ä¸ªheapsnapshotæ–‡ä»¶ï¼Œ

é€‰æ‹©å·¦ä¸Šè§’çš„Comparsion å³å¯¹æ¯”2æ¬¡å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œä¸‹é¢æ•°æ® + å³è¡¨ç¤ºå¢é¡¹çš„å†…å­˜ï¼Œ- è¡¨ç¤ºå‡å°‘çš„ã€‚ image

è¿™æ ·å°±å¯ä»¥è½»æ¾çš„çŸ¥é“ä»€ä¹ˆåœ¨å¢åŠ ï¼Œå¢åŠ é‡Œå¤šå°‘ã€‚æ‰¾å‡ºå¼‚å¸¸çš„ç‚¹å¼€è¿›è¡Œåˆ†æã€‚

CPU image

æ‰“å¼€JavaScript Profiler é¢æ¿ï¼ŒåŒæ ·load cpuprofileæ–‡ä»¶ï¼Œé¢æ¿ä¼šå°†æœ€è€—æ—¶çš„æ–¹æ³•æ”¾åœ¨ä¸Šé¢ï¼Œå‰”é™¤programå’ŒGCæ¶ˆè€—ï¼Œæ£€æŸ¥æœ€è€—æ—¶çš„functionæ¥ä¼˜åŒ–ã€‚

2. ä½¿ç”¨alinodeè¿›è¡Œåˆ†æï¼ˆå¼ºçƒˆæ¨èï¼‰
é˜¿é‡Œäº‘ç™»å½• - æ¬¢è¿ç™»å½•é˜¿é‡Œäº‘ï¼Œå®‰å…¨ç¨³å®šçš„äº‘è®¡ç®—æœåŠ¡å¹³å°

ç™»é™†alinodeï¼Œåˆ›å»ºæ–°åº”ç”¨ï¼Œåˆ›å»ºå¥½åï¼Œæ‰“å¼€ã€‚

heapsnapshotåˆ†æ
é€‰æ‹©ä¸Šä¼ æ–‡ä»¶ï¼Œé€‰æ‹© å †å¿«ç…§ï¼Œä¸Šä¼ åˆšæ‰çš„heapsnapshotæ–‡ä»¶

image

å®Œæˆåå¦‚ä¸‹ image

ç‚¹å‡»åˆ†æï¼Œä¼šæ˜¾ç¤ºå‡ºå†…å­˜æ³„éœ²å¯ç–‘ç‚¹ã€‚ğŸ‘ image

ç‚¹å‡»Arrayå…³é”®å­—è¿›å»æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼Œå‘ç°å†…å­˜å ç”¨æ¯”ä¾‹87.35%ï¼Œå†ç‚¹å‡»å…·ä½“ä¿¡æ¯å°±å¯ä»¥çŸ¥é“å“ªå—å†…å­˜æ³„éœ²äº†ã€‚ image

CPU æ¶ˆè€—åˆ†æ
é€‰æ‹©ä¸Šä¼ æ–‡ä»¶ï¼Œé€‰æ‹©cpu profileï¼Œä¸Šä¼ åˆšæ‰çš„cpuå¿«ç…§ã€‚

image

ç‚¹å‡»åˆ†æ image

æŸ¥çœ‹ç«ç„°å›¾ image

ç‚¹å‡»åˆ†æï¼ˆdevtoolï¼‰ï¼Œå’Œchromeé¢æ¿ä¸€æ ·ï¼Œä¸è¿‡ä¼šçº¢è‰²æ˜¾ç¤ºå¯èƒ½å¼‚å¸¸çš„function image

ä¸€ä¸ªçœŸå®çš„æ¡ˆä¾‹
kepler çº¿ä¸ŠæœåŠ¡å¤§é‡502ï¼Œæ˜¯AGè®¿é—®kepler serverå¾—ä¸åˆ°å“åº”ï¼Œkepler server éƒ¨ç½²åï¼Œå†…å­˜æ¶ˆè€—ä¸¥é‡ï¼Œæ‹–æ…¢ç¨‹åºè¿è¡Œï¼Œå¯¼è‡´å¤§é‡é“¾æ¥å“åº”è¶…è¿‡10sã€‚

é€šè¿‡alinodeå¯¹æµ‹è¯•æœåŠ¡å™¨ä¸ŠæœåŠ¡è¿›è¡Œç›‘æ§ï¼Œå¹¶å–å †å¿«ç…§ã€‚å‘ç°nodeç¨‹åº92%çš„å†…å­˜éƒ½æ¥æºäºä¸€ä¸ªArrayæ•°ç»„ï¼Œå¹¶æŒ‡å‘é…ç½®æ–‡ä»¶ app.jsonï¼Œ

image

image

æŸ¥çœ‹ç›¸å…³ä»£ç ï¼Œå‘ç°åœ¨ä»£ç å¦‚ä¸‹

//
delete require.cache[require.resolve('../configuration/app.json')];  
const { duration } = require('../configuration/app.json');
app.jsonæ˜¯å¯é…ç½®çš„ï¼Œå¦‚æœä½¿ç”¨requireä¼šæœ‰ç¼“å­˜é—®é¢˜ï¼Œå› æ­¤ä½¿ç”¨äº†delete require.cacheï¼Œç»“æœå¼•èµ·äº†å†…å­˜æ³„éœ²ã€‚

æŸ¥çœ‹ç½‘ä¸Šç›¸å…³ require.cache æ–‡ç« å‘ç°æ­¤é—®é¢˜æœ‰äººè¸©è¿‡ï¼Œå…·ä½“è§£é‡Šï¼š

node æºç ä¸­å…³äºmodule çš„æ–¹æ³•ï¼Œ

function Module(id, parent) {
  this.id = id;
  this.exports = {};
  this.parent = parent;
  if (parent && parent.children) {
    parent.children.push(this);
  }

  this.filename = null;
  this.loaded = false;
  this.children = [];
}
node åœ¨ module.js ä¸­è‡ªåŠ¨ä¸ºæ¨¡å—æ·»åŠ äº†å¼•ç”¨

delete require.cache ä»…ä»…æ¸…é™¤æ‰äº† Module._cache å¯¹æ–‡ä»¶ç¬¬ä¸€æ¬¡ require çš„å®ä¾‹çš„å¼•ç”¨
æ­¤æ—¶çˆ¶æ–‡ä»¶ require å®ä¾‹çš„ children æ•°ç»„ä¸­çš„ç¼“å­˜çš„å¼•ç”¨ä¾æ—§å­˜åœ¨ ä¸‹ä¸€æ¬¡ å† require æ­¤æ–‡ä»¶æ—¶ï¼Œç”±äº Module._cache ä¸­ä¸å­˜åœ¨ï¼Œä¼šå†ç”Ÿæˆä¸€æ¬¡æ–‡ä»¶å¯¹åº”çš„ Module å®ä¾‹ï¼ŒåŒæ—¶ç»™å…¶çˆ¶æ–‡ä»¶å®ä¾‹çš„ children æ•°ç»„å†å¢åŠ ä¸€ä¸ªå¼•ç”¨ï¼Œè¿™æ ·å°±é€ æˆäº†æ³„æ¼ã€‚


> Node æ€§èƒ½ä¼˜åŒ–ä¸é—®é¢˜æ’æŸ¥ï¼šhttps://topgrd.me/post/5/

> Node.js æ€§èƒ½å¹³å°æ–‡æ¡£ï¼šhttps://help.aliyun.com/product/60298.html?spm=5176.179584.935956.btn2.64bb5d0bJxau20

> Egg.js æ¡†æ¶é›†æˆé˜¿é‡Œ Node.js æ€§èƒ½å¹³å° alinodeï¼šhttps://www.jianshu.com/p/f39b55f8f164

